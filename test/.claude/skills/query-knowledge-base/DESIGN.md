# 设计思想总结

本文档总结了 `query-knowledge-base` 技能目录的整体设计理念和核心思想。

---

## 核心设计原则

### 1. **按需加载原则（Lazy Loading）**

**核心思想**：只在需要时读取对应的功能文档，避免预加载所有内容。

- `SKILL.md` 作为入口导航，明确提示"仅在需要时阅读对应指南"
- 搜索和添加功能完全分离，互不干扰
- 减少 AI 的上下文负担，提高执行效率

**实现方式**：
```
SKILL.md (入口)
  ├── 搜索功能 → search/SEARCH_GUIDE.md (决策层，按需读取)
  │   ├── sqlite-search/ (SQLite 搜索实现)
  │   └── vector-search/ (向量搜索实现)
  └── 添加功能 → add/ADD_GUIDE.md (按需读取)
```

---

### 2. **功能分离与职责清晰**

**目录结构**：
```
query-knowledge-base/
├── search/                    # 查询功能（三层决策架构）
│   ├── SEARCH_GUIDE.md        # 决策层：判断使用哪种搜索方式
│   ├── sqlite-search/         # SQLite 搜索实现
│   │   ├── SQLITE_SEARCH_GUIDE.md
│   │   ├── EXAMPLES.md
│   │   └── query_db.py
│   └── vector-search/         # 向量搜索实现
│       ├── VECTOR_SEARCH_GUIDE.md
│       ├── EXAMPLES.md
│       └── query_vector.py
└── add/                       # 添加功能（完全独立）
    ├── ADD_GUIDE.md           # 添加指南
    └── add_db.py              # 添加脚本
```

**设计优势**：
- 搜索和添加功能完全解耦
- 每个功能有独立的指南和脚本
- 降低认知负担，便于维护和扩展

---

### 3. **渐进式文档结构**

**设计理念**：API 参考整合到各功能指南中，而非独立的参考文档。

- `REFERENCE.md` 仅作为导航索引，指向具体指南
- 避免一次性加载全部 API 信息
- 实现"需要什么，加载什么"

**文档层次**：
```
REFERENCE.md (导航)
  ├── 搜索 API → search/SEARCH_GUIDE.md 的"API 参数参考"部分
  └── 添加 API → add/ADD_GUIDE.md 的"API 参数参考"部分
```

---

### 4. **Shell 友好设计**

**核心关注点**：特别关注 Shell 命令执行的细节和边界情况。

**关键设计**：
- 强调使用 `python3`（而非 `python`）避免兼容性问题
- 长内容使用命令替换 `$(cat <<'EOF')` 避免 Shell 解析错误
- 提供完整的 heredoc 使用示例
- 详细说明如何处理特殊字符、换行、代码块等边界情况

**示例**：
```bash
# 推荐方式：使用命令替换处理长内容
CONTENT=$(cat <<'EOF')
多行内容
包含特殊字符
EOF

python3 add_db.py --content "$CONTENT"
```

---

### 5. **实用导向的文档**

**设计特点**：
- **丰富的实际示例**：Markdown 文档、API 文档、配置说明等
- **常见问题解答**：FAQ 部分解决实际使用中的痛点
- **最佳实践建议**：标题选择、标签使用、内容结构化
- **快速参考表格**：便于快速查找命令和参数

**文档结构**：
```
GUIDE.md
├── 核心原则
├── 方法说明（多种实现方式）
├── 完整示例（多个场景）
├── 常见问题（FAQ）
├── 最佳实践
└── API 参数参考
```

---

### 6. **统一输出格式**

**设计决策**：所有脚本统一返回 JSON 格式。

**优势**：
- 便于后续处理和解析
- 支持 `jq`、`python -m json.tool` 等工具
- 便于 AI 理解和提取信息
- 统一的数据交换格式

---

### 7. **上下文优化**

**设计策略**：
- 文档间相互引用，形成清晰的导航链
- 每个指南末尾有"下一步"提示，引导用户
- 避免信息孤岛，保持文档的连贯性

**示例**：
```markdown
## 下一步
- **搜索内容**: 查看 [../search/SEARCH_GUIDE.md](../search/SEARCH_GUIDE.md)
- **使用示例**: 查看 [../search/EXAMPLES.md](../search/EXAMPLES.md)
```

---

## 三层决策架构（搜索功能）

### 架构设计

搜索功能采用三层决策架构，实现决策层与实现层的分离：

1. **决策层** (`search/SEARCH_GUIDE.md`)：
   - 根据查询意图判断使用哪种搜索方式
   - 提供决策规则和场景判断
   - 指向具体实现指南

2. **实现层 - SQLite 搜索** (`search/sqlite-search/`)：
   - 关键词匹配搜索
   - 标签筛选、ID 查询、列表查询
   - 独立的使用指南和示例

3. **实现层 - 向量搜索** (`search/vector-search/`)：
   - 语义相似度搜索
   - 通过 API 调用后端服务
   - 独立的使用指南和示例

### 设计优势

- **职责分离**：决策逻辑与实现逻辑分离，便于维护
- **按需加载**：AI 只需读取决策指南，根据判断再读取具体实现
- **易于扩展**：新增搜索方式只需添加新的实现层，不影响决策层
- **清晰导航**：决策层提供清晰的导航，指向具体实现

---

## 设计亮点

### 1. **以 AI 使用场景为中心**

- 充分考虑 AI 的上下文限制
- 采用按需加载策略，避免信息过载
- 优化 AI 的执行效率和准确性
- 三层决策架构进一步减少 AI 的认知负担

### 2. **降低错误率**

- 详细说明 Shell 命令执行的细节
- 提供多种场景的完整示例
- 明确标注注意事项和常见错误

### 3. **可维护性**

- 功能分离，便于独立更新和维护
- 清晰的文档结构，易于扩展
- 统一的格式和风格

### 4. **学习友好**

- 丰富的示例和场景说明
- 循序渐进的学习路径
- 快速参考和最佳实践指导

---

## 设计模式总结

| 设计模式 | 实现方式 | 优势 |
|---------|---------|------|
| **按需加载** | 功能分离 + 入口导航 | 减少上下文负担 |
| **渐进式文档** | API 整合到指南中 | 避免信息过载 |
| **Shell 友好** | 详细命令说明 + 示例 | 降低执行错误 |
| **实用导向** | 丰富示例 + FAQ | 提高可用性 |
| **统一格式** | JSON 输出 | 便于处理 |

---

## 总结

这是一个**面向 AI Agent 的技能文档系统**，核心设计理念是：

> **"按需加载、功能分离、实用导向"**

通过渐进式文档结构和 Shell 友好的设计，在保证功能完整性的同时，优化了 AI 的使用体验和执行效率。整个设计充分考虑了 AI 的使用场景和限制，是一个优秀的技能文档系统设计范例。

