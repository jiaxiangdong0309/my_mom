# AI 知识记忆库 - 架构设计文档 (简化版)

**版本**: v2.0 (极简版)
**日期**: 2025-12-25
**文档状态**: 初稿

---

## 1. 架构设计原则

### 1.1 核心原则

| 原则 | 说明 |
|------|------|
| **简单第一** | 怎么简单怎么来，快速实现 |
| **文件分层** | 保持基本文件夹组织，代码不混乱 |
| **直接实现** | 不搞抽象，直接用具体类 |
| **够用就行** | MVP Demo，不预留过度扩展 |

### 1.2 设计原则

```
✅ 极简方案:
- 直接用 ChromaDB，不抽象
- 直接用 SQLite，不抽象
- 直接用 sentence-transformers，不抽象
- 文件夹分好，代码清晰即可

❌ 不要的:
- ABC 抽象基类
- Adapter 层
- 工厂模式
- 复杂的依赖注入
```

---

## 2. 整体架构

### 2.1 超简单架构图

```
┌─────────────────────────────────────────┐
│         API 层 (FastAPI 路由)           │
│  /api/v1/memories  |  /api/v1/search   │
└───────────────────┬─────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│        业务层 (直接调用就行)            │
│     存储逻辑 | 搜索逻辑                 │
└───────────────────┬─────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
┌───────────┐ ┌─────────┐ ┌────────────┐
│  ChromaDB │ │ SQLite  │ │sent-trans  │
│(向量存储) │ │(数据)   │ │(Embedding) │
└───────────┘ └─────────┘ └────────────┘
```

### 2.2 极简目录结构

```
ai-memory-hub/
├── backend/
│   ├── main.py                 # FastAPI 入口
│   ├── config.py               # 配置（环境变量）
│   │
│   ├── api/                    # API 路由
│   │   ├── __init__.py
│   │   ├── memories.py         # 存储接口
│   │   ├── search.py           # 搜索接口
│   │   └── models.py           # Pydantic 模型
│   │
│   ├── core/                   # 核心功能（直接写逻辑）
│   │   ├── __init__.py
│   │   ├── chroma_db.py        # ChromaDB 封装
│   │   ├── sqlite_db.py        # SQLite 封装
│   │   └── embedding.py        # Embedding 封装
│   │
│   └── utils/                  # 工具函数
│       └── text_splitter.py    # 文本分段
│
├── frontend/                   # React 前端
│   ├── src/
│   │   ├── api/
│   │   ├── components/
│   │   └── App.jsx
│   └── package.json
│
├── data/                       # 数据存储（自动创建）
│   ├── chroma/                 # ChromaDB 数据
│   └── memories.db             # SQLite 数据库
│
├── requirements.txt
└── README.md
```

**就这么简单，没有复杂的分层！**

---

## 3. 核心代码实现（直接写，不抽象）

### 3.1 ChromaDB 封装（100 行搞定）

```python
# core/chroma_db.py

import chromadb
from chromadb.config import Settings
from typing import List, Dict, Optional
import numpy as np

class ChromaDB:
    """ChromaDB 简单封装"""

    def __init__(self, persist_dir: str = "./data/chroma"):
        self.client = chromadb.PersistentClient(
            path=persist_dir,
            settings=Settings(anonymized_telemetry=False)
        )
        self.collection = self.client.get_or_create_collection(
            name="memories",
            metadata={"hnsw:space": "cosine"}
        )

    def add_vectors(self, ids: List[str], embeddings: np.ndarray, metadatas: List[Dict]):
        """添加向量"""
        self.collection.add(
            ids=ids,
            embeddings=embeddings.tolist(),
            metadatas=metadatas
        )

    def search(self, query_embedding: np.ndarray, top_k: int = 3) -> List[Dict]:
        """向量搜索"""
        results = self.collection.query(
            query_embeddings=[query_embedding.tolist()],
            n_results=top_k
        )

        return [
            {
                "id": results["ids"][0][i],
                "score": 1 - results["distances"][0][i],  # 距离转相似度
                "metadata": results["metadatas"][0][i]
            }
            for i in range(len(results["ids"][0]))
        ]

    def delete(self, ids: List[str]):
        """删除向量"""
        self.collection.delete(ids=ids)
```

### 3.2 SQLite 封装（80 行搞定）

```python
# core/sqlite_db.py

import sqlite3
import json
from typing import List, Optional, Dict
from datetime import datetime

class SQLiteDB:
    """SQLite 简单封装"""

    def __init__(self, db_path: str = "./data/memories.db"):
        self.conn = sqlite3.connect(db_path, check_same_thread=False)
        self._init_tables()

    def _init_tables(self):
        """创建表"""
        self.conn.execute("""
            CREATE TABLE IF NOT EXISTS memories (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                tags TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        self.conn.commit()

    def create_memory(self, title: str, content: str, tags: List[str]) -> int:
        """创建记录"""
        cursor = self.conn.execute(
            "INSERT INTO memories (title, content, tags) VALUES (?, ?, ?)",
            (title, content, json.dumps(tags))
        )
        self.conn.commit()
        return cursor.lastrowid

    def get_memory(self, memory_id: int) -> Optional[Dict]:
        """获取单条记录"""
        row = self.conn.execute(
            "SELECT * FROM memories WHERE id = ?", (memory_id,)
        ).fetchone()

        if row:
            return {
                "id": row[0],
                "title": row[1],
                "content": row[2],
                "tags": json.loads(row[3]),
                "created_at": row[4]
            }
        return None

    def get_memories_by_ids(self, ids: List[int]) -> List[Dict]:
        """批量获取记录"""
        placeholders = ",".join("?" * len(ids))
        rows = self.conn.execute(
            f"SELECT * FROM memories WHERE id IN ({placeholders})", ids
        ).fetchall()

        return [
            {
                "id": row[0],
                "title": row[1],
                "content": row[2],
                "tags": json.loads(row[3]),
                "created_at": row[4]
            }
            for row in rows
        ]

    def delete_memory(self, memory_id: int) -> bool:
        """删除记录"""
        self.conn.execute("DELETE FROM memories WHERE id = ?", (memory_id,))
        self.conn.commit()
        return True
```

### 3.3 Embedding 封装（30 行搞定）

```python
# core/embedding.py

from sentence_transformers import SentenceTransformer
import numpy as np

class Embedding:
    """Embedding 简单封装"""

    def __init__(self, model_name: str = "BAAI/bge-small-zh-v1.5"):
        self.model = SentenceTransformer(model_name)

    def encode(self, text: str) -> np.ndarray:
        """生成向量"""
        return self.model.encode(text)
```

---

## 4. API 路由（直接写逻辑）

### 4.1 存储接口（50 行搞定）

```python
# api/memories.py

from fastapi import APIRouter, HTTPException
from api.models import MemoryCreate, MemoryResponse
from core.chroma_db import ChromaDB
from core.sqlite_db import SQLiteDB
from core.embedding import Embedding

router = APIRouter(prefix="/api/v1/memories", tags=["memories"])

# 直接实例化
chroma_db = ChromaDB()
sqlite_db = SQLiteDB()
embedder = Embedding()

@router.post("/", response_model=MemoryResponse)
async def create_memory(data: MemoryCreate):
    """存储记忆"""
    try:
        # 1. 保存到 SQLite
        memory_id = sqlite_db.create_memory(
            title=data.title,
            content=data.content,
            tags=data.tags
        )

        # 2. 生成向量
        text = f"{data.title}\n\n{data.content}"
        embedding = embedder.encode(text)

        # 3. 保存到 ChromaDB
        chroma_db.add_vectors(
            ids=[str(memory_id)],
            embeddings=embedding.reshape(1, -1),
            metadatas=[{
                "memory_id": memory_id,
                "title": data.title,
                "tags": ",".join(data.tags)
            }]
        )

        return MemoryResponse(id=memory_id)

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.delete("/{memory_id}")
async def delete_memory(memory_id: int):
    """删除记忆"""
    sqlite_db.delete_memory(memory_id)
    chroma_db.delete(ids=[str(memory_id)])
    return {"message": "deleted"}
```

### 4.2 搜索接口（40 行搞定）

```python
# api/search.py

from fastapi import APIRouter
from api.models import SearchRequest, SearchResult
from core.chroma_db import ChromaDB
from core.sqlite_db import SQLiteDB
from core.embedding import Embedding

router = APIRouter(prefix="/api/v1/search", tags=["search"])

chroma_db = ChromaDB()
sqlite_db = SQLiteDB()
embedder = Embedding()

@router.post("/", response_model=list[SearchResult])
async def search(data: SearchRequest):
    """语义搜索"""
    # 1. 查询向量化
    query_embedding = embedder.encode(data.query)

    # 2. 向量检索
    vector_results = chroma_db.search(query_embedding, top_k=data.limit)

    # 3. 获取完整数据
    memory_ids = [int(r["id"]) for r in vector_results]
    memories = sqlite_db.get_memories_by_ids(memory_ids)

    # 4. 合并结果
    results = []
    for i, memory in enumerate(memories):
        results.append(SearchResult(
            id=memory["id"],
            title=memory["title"],
            content=memory["content"],
            tags=memory["tags"],
            created_at=memory["created_at"],
            relevance=vector_results[i]["score"]
        ))

    return results
```

### 4.3 Pydantic 模型

```python
# api/models.py

from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

class MemoryCreate(BaseModel):
    title: str
    content: str
    tags: List[str]

class MemoryResponse(BaseModel):
    id: int
    title: str
    content: str
    tags: List[str]
    created_at: datetime

class SearchRequest(BaseModel):
    query: str
    limit: int = 3

class SearchResult(BaseModel):
    id: int
    title: str
    content: str
    tags: List[str]
    created_at: datetime
    relevance: float
```

### 4.4 主入口

```python
# main.py

from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from api import memories, search

app = FastAPI(title="AI Memory Hub")

# 注册路由
app.include_router(memories.router)
app.include_router(search.router)

# 挂载前端静态文件
app.mount("/", StaticFiles(directory="../frontend/dist"), name="frontend")

@app.get("/health")
async def health():
    return {"status": "ok"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=7937)
```

---

## 5. 配置管理（极简）

```python
# config.py

import os
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    """配置（支持环境变量）"""

    # 数据路径
    data_dir: str = "./data"
    chroma_dir: str = "./data/chroma"
    db_path: str = "./data/memories.db"

    # Embedding
    embedding_model: str = "BAAI/bge-small-zh-v1.5"

    # API
    port: int = 7937

    class Config:
        env_file = ".env"

settings = Settings()
```

---

## 6. 完整数据流

### 6.1 存储流程

```
POST /api/v1/memories
    ↓
memories.py (路由)
    ├→ SQLiteDB.create_memory()  → 保存到数据库
    ├→ Embedding.encode()        → 生成向量
    └→ ChromaDB.add_vectors()    → 保存向量
    ↓
返回 {id: 123}
```

### 6.2 搜索流程

```
POST /api/v1/search
    ↓
search.py (路由)
    ├→ Embedding.encode(query)   → 查询向量化
    ├→ ChromaDB.search()         → 向量检索 (返回 ID 列表)
    └→ SQLiteDB.get_memories_by_ids() → 获取完整数据
    ↓
返回 [{id, title, content, relevance}]
```

---

## 7. 依赖列表

```txt
# requirements.txt

fastapi==0.109.0
uvicorn[standard]==0.27.0
chromadb==0.4.22
sentence-transformers==2.2.2
pydantic==2.5.3
pydantic-settings==2.1.0
numpy==1.26.3
```

---

## 8. 代码量估算

| 模块 | 代码量 | 说明 |
|------|--------|------|
| **ChromaDB 封装** | ~100 行 | core/chroma_db.py |
| **SQLite 封装** | ~80 行 | core/sqlite_db.py |
| **Embedding 封装** | ~30 行 | core/embedding.py |
| **API 路由** | ~90 行 | api/memories.py + api/search.py |
| **Pydantic 模型** | ~40 行 | api/models.py |
| **主入口** | ~20 行 | main.py |
| **配置** | ~20 行 | config.py |
| **后端小计** | **~380 行** | |
| **前端 (React)** | ~600 行 | 简单 UI |
| **总计** | **~1000 行** | **3-5 天完成 MVP** |

---

## 9. 快速开始

### 9.1 安装依赖

```bash
pip install -r requirements.txt
```

### 9.2 启动服务

**重要提示**：AI 编程工具不应自动运行服务。如需运行服务，请提示用户手动启动，避免重复启动导致端口占用问题。

```bash
cd backend
python3 main.py
```

### 9.3 测试 API

```bash
# 存储记忆
curl -X POST http://localhost:7937/api/v1/memories \
  -H "Content-Type: application/json" \
  -d '{
    "title": "修复内存泄露",
    "content": "使用 pprof 分析发现是 goroutine 泄露",
    "tags": ["bug", "内存", "golang"]
  }'

# 搜索
curl -X POST http://localhost:7937/api/v1/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "之前怎么解决内存问题的？",
    "limit": 3
  }'
```

---

## 10. 优势总结

### 10.1 超级简单

```
✅ 直接实现，无抽象
✅ 文件夹分好，代码清晰
✅ 快速开发，3-5 天搞定 MVP
✅ 代码量少，~1000 行
```

### 10.2 够用就行

```
✅ 核心功能完整
✅ 向量搜索准确
✅ 本地部署，隐私保护
✅ 前后端分离
```

### 10.3 未来扩展（如果需要）

```
如果需要换向量库：
  直接改 core/chroma_db.py 为 Qdrant 实现

如果需要换 Embedding：
  直接改 core/embedding.py 为 Jina API

如果需要换数据库：
  直接改 core/sqlite_db.py 为 PostgreSQL
```

**虽然会改动代码，但 Demo 阶段谁在乎呢？先跑起来最重要！**

---

**文档结束**

现在这个架构超级简单，可以快速实现了！
